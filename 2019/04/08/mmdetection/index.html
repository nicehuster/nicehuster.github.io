<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="E3FpB-yqMjVKzHwdisKMpUn104x78HxTRcD4_v_URgc">







  <meta name="baidu-site-verification" content="wgGFRLcCc9">







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="mmdetection,">





  <link rel="alternate" href="/atom.xml" title="一起打怪升级呀" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="mmdetection是一款优秀的基于PyTorch的开源目标检测系统，由香港中文大学(CUHK)多媒体实验室(mmlab)开发。基本上支持所有当前SOTA二阶段的目标检测算法，比如faster rcnn，mask rcnn，r-fcn，cascade rcnn，此外还支持了SSD和RetinaNet等一阶段的目标检测算法。花了一天的时间大致地看了下框架的相关源代码，以下是部分整理纪录。">
<meta name="keywords" content="mmdetection">
<meta property="og:type" content="article">
<meta property="og:title" content="mmdetection使用以及源码解析">
<meta property="og:url" content="https://blog.nicehuster.cn/2019/04/08/mmdetection/index.html">
<meta property="og:site_name" content="一起打怪升级呀">
<meta property="og:description" content="mmdetection是一款优秀的基于PyTorch的开源目标检测系统，由香港中文大学(CUHK)多媒体实验室(mmlab)开发。基本上支持所有当前SOTA二阶段的目标检测算法，比如faster rcnn，mask rcnn，r-fcn，cascade rcnn，此外还支持了SSD和RetinaNet等一阶段的目标检测算法。花了一天的时间大致地看了下框架的相关源代码，以下是部分整理纪录。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://blog.nicehuster.cn/img/coco_test_12510.jpg">
<meta property="og:image" content="https://blog.nicehuster.cn/img/mmdetection_demo2.png">
<meta property="og:image" content="https://blog.nicehuster.cn/img/mmdetection_demo1.png">
<meta property="og:updated_time" content="2020-09-18T02:37:38.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mmdetection使用以及源码解析">
<meta name="twitter:description" content="mmdetection是一款优秀的基于PyTorch的开源目标检测系统，由香港中文大学(CUHK)多媒体实验室(mmlab)开发。基本上支持所有当前SOTA二阶段的目标检测算法，比如faster rcnn，mask rcnn，r-fcn，cascade rcnn，此外还支持了SSD和RetinaNet等一阶段的目标检测算法。花了一天的时间大致地看了下框架的相关源代码，以下是部分整理纪录。">
<meta name="twitter:image" content="https://blog.nicehuster.cn/img/coco_test_12510.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.nicehuster.cn/2019/04/08/mmdetection/">





  <title>mmdetection使用以及源码解析 | 一起打怪升级呀</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一起打怪升级呀</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">别整太大鸭力,多鸡立自己qaq</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.nicehuster.cn/2019/04/08/mmdetection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nicehuster">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/avatar/weichat.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一起打怪升级呀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">mmdetection使用以及源码解析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-08T19:13:39+08:00">
                2019-04-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/project/" itemprop="url" rel="index">
                    <span itemprop="name">project</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://github.com/open-mmlab/mmdetection" target="_blank" rel="noopener">mmdetection</a>是一款优秀的基于PyTorch的开源目标检测系统，由香港中文大学(CUHK)多媒体实验室(mmlab)开发。基本上支持所有当前SOTA二阶段的目标检测算法，比如faster rcnn，mask rcnn，r-fcn，cascade rcnn，此外还支持了SSD和RetinaNet等一阶段的目标检测算法。花了一天的时间大致地看了下框架的相关源代码，以下是部分整理纪录。<br><img src="/img/coco_test_12510.jpg" alt><br><a id="more"></a></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>项目地址：<a href="https://github.com/open-mmlab/mmdetection" target="_blank" rel="noopener">open-mmlab/mmdetection</a>。安装：<a href="https://github.com/open-mmlab/mmdetection/blob/master/INSTALL.md" target="_blank" rel="noopener">mmdetection/INSTALL.md</a>。<br>当前该项目已经迁移到pytorch1.0版本，如果需要使用pytorch0.4可以使用如下命令进行切换：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/open-mmlab/mmdetection.git</span><br><span class="line">git checkout pytorch-<span class="number">0.4</span>.<span class="number">1</span>  <span class="comment">#切换至0.4.1版本</span></span><br></pre></td></tr></table></figure></p>
<p>此外，该项目依赖于<a href="https://github.com/open-mmlab/mmcv" target="_blank" rel="noopener">open-mmlab/mmcv</a>。这个项目也是CUHK的开源的一个计算机视觉库，主要包括一些图像/视频数据读取，预处理，可视化，过程显示等操作。可以直接使用pip安装：<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> mmcv</span><br></pre></td></tr></table></figure></p>
<h3 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h3><h4 id="tools-train-py使用"><a href="#tools-train-py使用" class="headerlink" title="tools/train.py使用"></a>tools/train.py使用</h4><p>mmdetection项目中给了许多模型的训练配置文件，其中包括不同backbone的cascade rcnn, faster rcnn，mask rcnn以及retinanet和SSD等检测模型。比如训练一个backbone为resnet50的 mask rcnn模型：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">python</span> tools/train.<span class="keyword">py</span> configs/mask_rcnn_r50_fpn_1x.<span class="keyword">py</span></span><br></pre></td></tr></table></figure></p>
<p>有关训练模型的具体配置比如backbone选取，anchor参数配置，训练/验证，数据集，optimizer参数，迭代次数等等，都可以在configs/*.py文件中进行配置修改。train.py文件中还包括一些其他输入参数选项：</p>
<blockquote>
<ul>
<li>—work_dir 是模型checkpoint文件的输出目录，可以在configs/*.py中配置；</li>
<li>—resume_from 是指定在某个checkpoint的基础上继续训练，可以在configs/*.py中配置；</li>
<li>—validate 是指是否在训练中是否对每个checkpoint都进行评估，默认是true</li>
<li>—gpus 是指使用的GPU数量，默认值为1；</li>
<li>—launcher 是指分布式训练的任务启动器（job launcher），默认值为none表示不进行分布式训练；</li>
</ul>
</blockquote>
<p>mmdetection也给出了分布式训练的脚本，可以在单机或多机上进行分布式训练。<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="meta-keyword">/tools/</span>dist_train.sh <span class="params">&lt;config_file&gt;</span> <span class="params">&lt;GPU_NUM&gt;</span> [optional arg]</span><br></pre></td></tr></table></figure></p>
<h4 id="tools-train-py源码解析"><a href="#tools-train-py源码解析" class="headerlink" title="tools/train.py源码解析"></a>tools/train.py源码解析</h4><p>具体<a href="https://github.com/open-mmlab/mmdetection/blob/master/tools/train.py" target="_blank" rel="noopener">源代码</a>如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> mmcv <span class="keyword">import</span> Config</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mmdet <span class="keyword">import</span> __version__</span><br><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> get_dataset</span><br><span class="line"><span class="keyword">from</span> mmdet.apis <span class="keyword">import</span> (train_detector, init_dist, get_root_logger,</span><br><span class="line">                        set_random_seed)</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> build_detector</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_args</span><span class="params">()</span>:</span></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Train a detector'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'config'</span>, help=<span class="string">'train config file path'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--work_dir'</span>, help=<span class="string">'the dir to save logs and models'</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--resume_from'</span>, help=<span class="string">'the checkpoint file to resume from'</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--validate'</span>,</span><br><span class="line">        action=<span class="string">'store_true'</span>,</span><br><span class="line">        help=<span class="string">'whether to evaluate the checkpoint during training'</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--gpus'</span>,</span><br><span class="line">        type=int,</span><br><span class="line">        default=<span class="number">1</span>,</span><br><span class="line">        help=<span class="string">'number of gpus to use '</span></span><br><span class="line">        <span class="string">'(only applicable to non-distributed training)'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--seed'</span>, type=int, default=<span class="keyword">None</span>, help=<span class="string">'random seed'</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--launcher'</span>,</span><br><span class="line">        choices=[<span class="string">'none'</span>, <span class="string">'pytorch'</span>, <span class="string">'slurm'</span>, <span class="string">'mpi'</span>],</span><br><span class="line">        default=<span class="string">'none'</span>,</span><br><span class="line">        help=<span class="string">'job launcher'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--local_rank'</span>, type=int, default=<span class="number">0</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    args = parse_args() <span class="comment">#读取一些命令行必要参数</span></span><br><span class="line"></span><br><span class="line">    cfg = Config.fromfile(args.config)   </span><br><span class="line">    <span class="comment"># 1.参数读取：读取configs/*.py文件，并建立mmcv.config对象用于后续模型训练参数设置</span></span><br><span class="line">    <span class="comment"># set cudnn_benchmark</span></span><br><span class="line">    <span class="keyword">if</span> cfg.get(<span class="string">'cudnn_benchmark'</span>, <span class="keyword">False</span>):</span><br><span class="line">        torch.backends.cudnn.benchmark = <span class="keyword">True</span></span><br><span class="line">    <span class="comment"># update configs according to CLI args</span></span><br><span class="line">    <span class="keyword">if</span> args.work_dir <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        cfg.work_dir = args.work_dir</span><br><span class="line">    <span class="keyword">if</span> args.resume_from <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        cfg.resume_from = args.resume_from</span><br><span class="line">    cfg.gpus = args.gpus</span><br><span class="line">    <span class="keyword">if</span> cfg.checkpoint_config <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="comment"># save mmdet version in checkpoints as meta data</span></span><br><span class="line">        cfg.checkpoint_config.meta = dict(</span><br><span class="line">            mmdet_version=__version__, config=cfg.text)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># init distributed env first, since logger depends on the dist info.</span></span><br><span class="line">    <span class="keyword">if</span> args.launcher == <span class="string">'none'</span>:</span><br><span class="line">        distributed = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        distributed = <span class="keyword">True</span></span><br><span class="line">        init_dist(args.launcher, **cfg.dist_params)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># init logger before other steps</span></span><br><span class="line">    logger = get_root_logger(cfg.log_level)</span><br><span class="line">    logger.info(<span class="string">'Distributed training: &#123;&#125;'</span>.format(distributed))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set random seeds</span></span><br><span class="line">    <span class="keyword">if</span> args.seed <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        logger.info(<span class="string">'Set random seed to &#123;&#125;'</span>.format(args.seed))</span><br><span class="line">        set_random_seed(args.seed)</span><br><span class="line"></span><br><span class="line">    model = build_detector(</span><br><span class="line">        cfg.model, train_cfg=cfg.train_cfg, test_cfg=cfg.test_cfg)</span><br><span class="line">    <span class="comment"># 2.构建模型：调用mmdet.models.build_detector，从config中读取必要的模型参数构建模型</span></span><br><span class="line">    train_dataset = get_dataset(cfg.data.train)</span><br><span class="line">    <span class="comment"># 3.数据集读取：调用mmdet.datasets.get_dataset，根据从配置文件中读取训练测试数据集的信息，建立数据集对象</span></span><br><span class="line">    train_detector(</span><br><span class="line">        model,</span><br><span class="line">        train_dataset,</span><br><span class="line">        cfg,</span><br><span class="line">        distributed=distributed,</span><br><span class="line">        validate=args.validate,</span><br><span class="line">        logger=logger)</span><br><span class="line">    <span class="comment"># 4.训练模型：调用mmdet.apis.train_detector方法，输入上面构建好的模型、数据集以及配置参数开始训练模型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<p>可以看出模型的训练入口在于调用mmdet.apis.train_detector。该接口的实现在<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/apis/train.py" target="_blank" rel="noopener">mmdet.apis.train.py</a>，具体源代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> mmcv.runner <span class="keyword">import</span> Runner, DistSamplerSeedHook</span><br><span class="line"><span class="keyword">from</span> mmcv.parallel <span class="keyword">import</span> MMDataParallel, MMDistributedDataParallel</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mmdet.core <span class="keyword">import</span> (DistOptimizerHook, DistEvalmAPHook,</span><br><span class="line">                        CocoDistEvalRecallHook, CocoDistEvalmAPHook)</span><br><span class="line"><span class="keyword">from</span> mmdet.datasets <span class="keyword">import</span> build_dataloader</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> RPN</span><br><span class="line"><span class="keyword">from</span> .env <span class="keyword">import</span> get_root_logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_losses</span><span class="params">(losses)</span>:</span></span><br><span class="line">    log_vars = OrderedDict()</span><br><span class="line">    <span class="keyword">for</span> loss_name, loss_value <span class="keyword">in</span> losses.items():</span><br><span class="line">        <span class="keyword">if</span> isinstance(loss_value, torch.Tensor):</span><br><span class="line">            log_vars[loss_name] = loss_value.mean()</span><br><span class="line">        <span class="keyword">elif</span> isinstance(loss_value, list):</span><br><span class="line">            log_vars[loss_name] = sum(_loss.mean() <span class="keyword">for</span> _loss <span class="keyword">in</span> loss_value)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(</span><br><span class="line">                <span class="string">'&#123;&#125; is not a tensor or list of tensors'</span>.format(loss_name))</span><br><span class="line"></span><br><span class="line">    loss = sum(_value <span class="keyword">for</span> _key, _value <span class="keyword">in</span> log_vars.items() <span class="keyword">if</span> <span class="string">'loss'</span> <span class="keyword">in</span> _key)</span><br><span class="line"></span><br><span class="line">    log_vars[<span class="string">'loss'</span>] = loss</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> log_vars:</span><br><span class="line">        log_vars[name] = log_vars[name].item()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loss, log_vars</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">batch_processor</span><span class="params">(model, data, train_mode)</span>:</span></span><br><span class="line">    losses = model(**data)</span><br><span class="line">    loss, log_vars = parse_losses(losses)</span><br><span class="line"></span><br><span class="line">    outputs = dict(</span><br><span class="line">        loss=loss, log_vars=log_vars, num_samples=len(data[<span class="string">'img'</span>].data))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_detector</span><span class="params">(model,</span></span></span><br><span class="line"><span class="function"><span class="params">                   dataset,</span></span></span><br><span class="line"><span class="function"><span class="params">                   cfg,</span></span></span><br><span class="line"><span class="function"><span class="params">                   distributed=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                   validate=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                   logger=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> logger <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        logger = get_root_logger(cfg.log_level)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># start training</span></span><br><span class="line">    <span class="keyword">if</span> distributed:</span><br><span class="line">        _dist_train(model, dataset, cfg, validate=validate)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        _non_dist_train(model, dataset, cfg, validate=validate)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_dist_train</span><span class="params">(model, dataset, cfg, validate=False)</span>:</span></span><br><span class="line">    <span class="comment"># prepare data loaders</span></span><br><span class="line">    data_loaders = [</span><br><span class="line">        build_dataloader(</span><br><span class="line">            dataset,</span><br><span class="line">            cfg.data.imgs_per_gpu,</span><br><span class="line">            cfg.data.workers_per_gpu,</span><br><span class="line">            dist=<span class="keyword">True</span>)</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># put model on gpus</span></span><br><span class="line">    model = MMDistributedDataParallel(model.cuda())</span><br><span class="line">    <span class="comment"># build runner</span></span><br><span class="line">    runner = Runner(model, batch_processor, cfg.optimizer, cfg.work_dir,</span><br><span class="line">                    cfg.log_level)</span><br><span class="line">    <span class="comment"># register hooks</span></span><br><span class="line">    optimizer_config = DistOptimizerHook(**cfg.optimizer_config)</span><br><span class="line">    runner.register_training_hooks(cfg.lr_config, optimizer_config,</span><br><span class="line">                                   cfg.checkpoint_config, cfg.log_config)</span><br><span class="line">    runner.register_hook(DistSamplerSeedHook())</span><br><span class="line">    <span class="comment"># register eval hooks</span></span><br><span class="line">    <span class="keyword">if</span> validate:</span><br><span class="line">        <span class="keyword">if</span> isinstance(model.module, RPN):</span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> implement recall hooks for other datasets</span></span><br><span class="line">            runner.register_hook(CocoDistEvalRecallHook(cfg.data.val))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> cfg.data.val.type == <span class="string">'CocoDataset'</span>:</span><br><span class="line">                runner.register_hook(CocoDistEvalmAPHook(cfg.data.val))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                runner.register_hook(DistEvalmAPHook(cfg.data.val))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cfg.resume_from:</span><br><span class="line">        runner.resume(cfg.resume_from)</span><br><span class="line">    <span class="keyword">elif</span> cfg.load_from:</span><br><span class="line">        runner.load_checkpoint(cfg.load_from)</span><br><span class="line">    runner.run(data_loaders, cfg.workflow, cfg.total_epochs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_non_dist_train</span><span class="params">(model, dataset, cfg, validate=False)</span>:</span></span><br><span class="line">    <span class="comment"># prepare data loaders</span></span><br><span class="line">    data_loaders = [</span><br><span class="line">        build_dataloader(</span><br><span class="line">            dataset,</span><br><span class="line">            cfg.data.imgs_per_gpu,</span><br><span class="line">            cfg.data.workers_per_gpu,</span><br><span class="line">            cfg.gpus,</span><br><span class="line">            dist=<span class="keyword">False</span>)</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># put model on gpus</span></span><br><span class="line">    model = MMDataParallel(model, device_ids=range(cfg.gpus)).cuda()</span><br><span class="line">    <span class="comment"># build runner</span></span><br><span class="line">    runner = Runner(model, batch_processor, cfg.optimizer, cfg.work_dir,</span><br><span class="line">                    cfg.log_level)</span><br><span class="line">    runner.register_training_hooks(cfg.lr_config, cfg.optimizer_config,</span><br><span class="line">                                   cfg.checkpoint_config, cfg.log_config)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cfg.resume_from:</span><br><span class="line">        runner.resume(cfg.resume_from)</span><br><span class="line">    <span class="keyword">elif</span> cfg.load_from:</span><br><span class="line">        runner.load_checkpoint(cfg.load_from)</span><br><span class="line">    runner.run(data_loaders, cfg.workflow, cfg.total_epochs)</span><br></pre></td></tr></table></figure></p>
<p>从源码可以看出train_detector的实现很简洁，通过是否分布式训练作为分支判断，分别调用_dist_train和_non_dist_train。这两个函数的接口实现也十分简洁明了。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="tools-test-py使用"><a href="#tools-test-py使用" class="headerlink" title="tools/test.py使用"></a>tools/test.py使用</h4><p>tools/test.py用于对训练好的模型进行测试评估。例如对mask rcnn模型使用两个GPU进行测试，并将测试结果保存在results.pkl中中，评测对象为box和segm<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python tools/test<span class="selector-class">.py</span> configs/mask_rcnn_r50_fpn_1x<span class="selector-class">.py</span> mask_rcnn_r50_fpn_1x_20181010-<span class="number">41</span>d35c05<span class="selector-class">.pth</span> --gpus <span class="number">2</span> --out results<span class="selector-class">.pkl</span> --eval bbox segm</span><br></pre></td></tr></table></figure></p>
<p>比如我用coco2014测试的结果如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Running per image evaluation<span class="built_in">..</span>.</span><br><span class="line">Evaluate annotation<span class="built_in"> type </span><span class="number">*bb</span>ox*</span><br><span class="line">DONE (<span class="attribute">t</span>=397.04s).</span><br><span class="line">Accumulating evaluation results<span class="built_in">..</span>.</span><br><span class="line">DONE (<span class="attribute">t</span>=62.48s).</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50:0.95 | area=   all | <span class="attribute">maxDets</span>=100 ] = 0.487</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50      | area=   all | <span class="attribute">maxDets</span>=100 ] = 0.725</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.75      | area=   all | <span class="attribute">maxDets</span>=100 ] = 0.548</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50:0.95 | area= small | <span class="attribute">maxDets</span>=100 ] = 0.328</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50:0.95 | <span class="attribute">area</span>=medium | <span class="attribute">maxDets</span>=100 ] = 0.540</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50:0.95 | area= large | <span class="attribute">maxDets</span>=100 ] = 0.574</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area=   all | maxDets=  1 ] = 0.368</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area=   all | maxDets= 10 ] = 0.591</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area=   all | <span class="attribute">maxDets</span>=100 ] = 0.618</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area= small | <span class="attribute">maxDets</span>=100 ] = 0.447</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | <span class="attribute">area</span>=medium | <span class="attribute">maxDets</span>=100 ] = 0.670</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area= large | <span class="attribute">maxDets</span>=100 ] = 0.738</span><br><span class="line">Running per image evaluation<span class="built_in">..</span>.</span><br><span class="line">Evaluate annotation<span class="built_in"> type </span>*segm*</span><br><span class="line">DONE (<span class="attribute">t</span>=436.20s).</span><br><span class="line">Accumulating evaluation results<span class="built_in">..</span>.</span><br><span class="line">DONE (<span class="attribute">t</span>=62.29s).</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50:0.95 | area=   all | <span class="attribute">maxDets</span>=100 ] = 0.430</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50      | area=   all | <span class="attribute">maxDets</span>=100 ] = 0.683</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.75      | area=   all | <span class="attribute">maxDets</span>=100 ] = 0.467</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50:0.95 | area= small | <span class="attribute">maxDets</span>=100 ] = 0.266</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50:0.95 | <span class="attribute">area</span>=medium | <span class="attribute">maxDets</span>=100 ] = 0.476</span><br><span class="line"> Average Precision  (AP) @[ <span class="attribute">IoU</span>=0.50:0.95 | area= large | <span class="attribute">maxDets</span>=100 ] = 0.541</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area=   all | maxDets=  1 ] = 0.341</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area=   all | maxDets= 10 ] = 0.533</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area=   all | <span class="attribute">maxDets</span>=100 ] = 0.555</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area= small | <span class="attribute">maxDets</span>=100 ] = 0.376</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | <span class="attribute">area</span>=medium | <span class="attribute">maxDets</span>=100 ] = 0.605</span><br><span class="line"> Average Recall     (AR) @[ <span class="attribute">IoU</span>=0.50:0.95 | area= large | <span class="attribute">maxDets</span>=100 ] = 0.703</span><br></pre></td></tr></table></figure></p>
<p>此处的格式化输出称为检测评价矩阵（detection evaluation metrics）。上面分别计算了box和segm在小目标、中目标以及大目标上的AP和AR值。具体参数说明，可以在coco官网上了解，在<a href="http://cocodataset.org/#detection-eval" target="_blank" rel="noopener">这里</a>。在mmdetection中评测的底层实现mmdet.core.evaluation.coco_eval使用的是coco那一套，也是直接调用Moicrosoft的coco API中的pycocotools包来实现的。具体<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/evaluation/coco_utils.py" target="_blank" rel="noopener">源代码</a>如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coco_eval</span><span class="params">(result_file, result_types, coco, max_dets=<span class="params">(<span class="number">100</span>, <span class="number">300</span>, <span class="number">1000</span>)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> res_type <span class="keyword">in</span> result_types:</span><br><span class="line">        <span class="keyword">assert</span> res_type <span class="keyword">in</span> [</span><br><span class="line">            <span class="string">'proposal'</span>, <span class="string">'proposal_fast'</span>, <span class="string">'bbox'</span>, <span class="string">'segm'</span>, <span class="string">'keypoints'</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mmcv.is_str(coco):</span><br><span class="line">        coco = COCO(coco)</span><br><span class="line">    <span class="keyword">assert</span> isinstance(coco, COCO)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> result_types == [<span class="string">'proposal_fast'</span>]:</span><br><span class="line">        ar = fast_eval_recall(result_file, coco, np.array(max_dets))</span><br><span class="line">        <span class="keyword">for</span> i, num <span class="keyword">in</span> enumerate(max_dets):</span><br><span class="line">            print(<span class="string">'AR@&#123;&#125;\t= &#123;:.4f&#125;'</span>.format(num, ar[i]))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> result_file.endswith(<span class="string">'.json'</span>)</span><br><span class="line">    coco_dets = coco.loadRes(result_file)</span><br><span class="line"></span><br><span class="line">    img_ids = coco.getImgIds()</span><br><span class="line">    <span class="keyword">for</span> res_type <span class="keyword">in</span> result_types:</span><br><span class="line">        iou_type = <span class="string">'bbox'</span> <span class="keyword">if</span> res_type == <span class="string">'proposal'</span> <span class="keyword">else</span> res_type</span><br><span class="line">        cocoEval = COCOeval(coco, coco_dets, iou_type)  <span class="comment">#构造COCOeval对象</span></span><br><span class="line">        cocoEval.params.imgIds = img_ids</span><br><span class="line">        <span class="keyword">if</span> res_type == <span class="string">'proposal'</span>:</span><br><span class="line">            cocoEval.params.useCats = <span class="number">0</span></span><br><span class="line">            cocoEval.params.maxDets = list(max_dets)</span><br><span class="line">        <span class="comment">#依次调用evaluate,accumulate,summarize实现数据集评测</span></span><br><span class="line">        cocoEval.evaluate() </span><br><span class="line">        cocoEval.accumulate()</span><br><span class="line">        cocoEval.summarize()</span><br></pre></td></tr></table></figure></p>
<p>从上面代码可以很清晰的看到，coco_eval函数主要是通过构造COCOeval对象，然后依次调用evaluate,accumulate,summarize实现数据集的评测。</p>
<h4 id="可视化预测"><a href="#可视化预测" class="headerlink" title="可视化预测"></a>可视化预测</h4><p>如果支持X Server，可以显示图形界面，则可以通过—show选项对测试图片进行显示输出：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">python</span> tools/test.<span class="keyword">py</span> <span class="symbol">&lt;CONFIG_FILE&gt;</span> <span class="symbol">&lt;CHECKPOINT_FILE&gt;</span> --show</span><br></pre></td></tr></table></figure></p>
<p>在这里，强烈安利装<a href="https://mobaxterm.mobatek.net/" target="_blank" rel="noopener">MobaXterm</a>远程连接神器，可以直接在Windows上使用SSH连接linux服务器，而且可以实现远程图像显示，比如常见的plt.show，以及cv2.imshow。在这里推荐下载破解版，下载地址在<a href="https://masuit.com/1347" target="_blank" rel="noopener">这里</a>。<br>关于tools/test.py源码介绍，作者写的比较简洁，可以自行阅读。</p>
<h3 id="models模型实现"><a href="#models模型实现" class="headerlink" title="models模型实现"></a>models模型实现</h3><p>关于模型的实现，在mmdetection中也做了一些介绍，具体可以参考<a href="https://github.com/open-mmlab/mmdetection/blob/master/TECHNICAL_DETAILS.md" target="_blank" rel="noopener">TECHNICAL_DETAILS.md</a>文件。下面的主要内容也是来自这个文件。<br>在mmdetection中，模型主要由如下四个部分组成：</p>
<blockquote>
<ul>
<li><strong>backbone</strong>： tong通常是一个全卷积网络用于提取feature map，比如ResNet网络</li>
<li><strong>neck</strong>: 连接backbone和head之间的部分，比如FPN,ASPP，值得注意的是，目前只支持FPN一种，不过看request，应该很快就可以支持不带FPN的模型</li>
<li><strong>head</strong>: 用于特定任务的部分，比如bbox预测，mask预测</li>
<li><strong>ROI extractor</strong>: 用于从feature map中提取特征的部分，比如ROI Align</li>
</ul>
</blockquote>
<p>此外，在mmdetection的TECHNICAL_DETAILS文件中提到，已经实现了一些包含以上部分的通用的pipeline,比如SingleStageDetector和TwoStageDetector。可以通过这两个类的实现来阅读代码理解mmdetection框架实现的基本原理。<br>SingleStageDetector和TwoStageDetector均位于mmdet.models.detectors中，分别在<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/detectors/single_stage.py" target="_blank" rel="noopener">single_stage.py</a>和<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/detectors/two_stage.py" target="_blank" rel="noopener">two_stage.py</a>中实现。</p>
<h4 id="single-stage-py源码解析"><a href="#single-stage-py源码解析" class="headerlink" title="single_stage.py源码解析"></a>single_stage.py源码解析</h4><p>在mmdetection中实现了一个通用的单stage目标检测模型，在mmdet/models/detectors/single_stage.py实现了一个通用的基础单Stage目标检测模型文件中，具体<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/detectors/single_stage.py" target="_blank" rel="noopener">源代码</a>如下：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">import torch.nn as nn</span><br><span class="line"></span><br><span class="line">from .base import BaseDetector</span><br><span class="line">from .. import builder</span><br><span class="line">from ..registry import DETECTORS</span><br><span class="line">from mmdet.core import bbox2result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@DETECTORS.register_module</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleStageDetector</span>(<span class="title">BaseDetector</span>): <span class="comment">#继承BaseDetector</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 backbone,</span></span></span><br><span class="line"><span class="function"><span class="params">                 neck=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 bbox_head=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 train_cfg=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 test_cfg=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 pretrained=None)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="comment">#定义基础结构：backbone + neck + bbox_head, 训练测试参数初始化：train_cfg +  test_cfg</span></span><br><span class="line">        <span class="keyword">super</span>(SingleStageDetector, <span class="keyword">self</span>).__init_<span class="number">_</span>()</span><br><span class="line">        <span class="keyword">self</span>.backbone = builder.build_backbone(backbone)</span><br><span class="line">        <span class="keyword">if</span> neck is <span class="keyword">not</span> <span class="symbol">None:</span></span><br><span class="line">            <span class="keyword">self</span>.neck = builder.build_neck(neck)</span><br><span class="line">        <span class="keyword">self</span>.bbox_head = builder.build_head(bbox_head)</span><br><span class="line">        <span class="keyword">self</span>.train_cfg = train_cfg</span><br><span class="line">        <span class="keyword">self</span>.test_cfg = test_cfg</span><br><span class="line">        <span class="keyword">self</span>.init_weights(pretrained=pretrained)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_weights</span><span class="params">(<span class="keyword">self</span>, pretrained=None)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">super</span>(SingleStageDetector, <span class="keyword">self</span>).init_weights(pretrained)</span><br><span class="line">        <span class="keyword">self</span>.backbone.init_weights(pretrained=pretrained)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_neck:</span></span><br><span class="line">            <span class="keyword">if</span> isinstance(<span class="keyword">self</span>.neck, nn.Sequential)<span class="symbol">:</span></span><br><span class="line">                <span class="keyword">for</span> m <span class="keyword">in</span> <span class="keyword">self</span>.<span class="symbol">neck:</span></span><br><span class="line">                    m.init_weights()</span><br><span class="line">            <span class="symbol">else:</span></span><br><span class="line">                <span class="keyword">self</span>.neck.init_weights()</span><br><span class="line">        <span class="keyword">self</span>.bbox_head.init_weights()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">extract_feat</span><span class="params">(<span class="keyword">self</span>, img)</span></span><span class="symbol">:</span></span><br><span class="line">        x = <span class="keyword">self</span>.backbone(img)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_neck:</span></span><br><span class="line">            x = <span class="keyword">self</span>.neck(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward_train</span><span class="params">(<span class="keyword">self</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      img,</span></span></span><br><span class="line"><span class="function"><span class="params">                      img_metas,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_bboxes,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_labels,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_bboxes_ignore=None)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="comment"># 定义模型的前向传播训练，输出训练时的损失losses</span></span><br><span class="line">        x = <span class="keyword">self</span>.extract_feat(img)</span><br><span class="line">        outs = <span class="keyword">self</span>.bbox_head(x)</span><br><span class="line">        loss_inputs = outs + (gt_bboxes, gt_labels, img_metas, <span class="keyword">self</span>.train_cfg)</span><br><span class="line">        losses = <span class="keyword">self</span>.bbox_head.loss(</span><br><span class="line">            *loss_inputs, gt_bboxes_ignore=gt_bboxes_ignore)</span><br><span class="line">        <span class="keyword">return</span> losses</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">simple_test</span><span class="params">(<span class="keyword">self</span>, img, img_meta, rescale=False)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="comment"># 定义模型度测试（无数据增强）,返回的bbox_results包含det_bboxes和 det_labels信息</span></span><br><span class="line">        x = <span class="keyword">self</span>.extract_feat(img)</span><br><span class="line">        outs = <span class="keyword">self</span>.bbox_head(x)</span><br><span class="line">        bbox_inputs = outs + (img_meta, <span class="keyword">self</span>.test_cfg, rescale)</span><br><span class="line">        bbox_list = <span class="keyword">self</span>.bbox_head.get_bboxes(*bbox_inputs)</span><br><span class="line">        bbox_results = [</span><br><span class="line">            bbox2result(det_bboxes, det_labels, <span class="keyword">self</span>.bbox_head.num_classes)</span><br><span class="line">            <span class="keyword">for</span> det_bboxes, det_labels <span class="keyword">in</span> bbox_list</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">return</span> bbox_results[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aug_test</span><span class="params">(<span class="keyword">self</span>, imgs, img_metas, rescale=False)</span></span><span class="symbol">:</span></span><br><span class="line">    <span class="comment">#定义模型测试（数据增强，比如多尺度，翻转）</span></span><br><span class="line">        raise NotImplementedError</span><br></pre></td></tr></table></figure></p>
<h4 id="two-stage-py源码解析"><a href="#two-stage-py源码解析" class="headerlink" title="two_stage.py源码解析"></a>two_stage.py源码解析</h4><p>同样，在mmdetection中也实现了一个通用的two-stage目标检测模型，在mmdet/models/detectors/two_stage.py实现了一个通用的基础two-Stage目标检测模型文件中，考虑到篇幅问题，不列具体<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/detectors/two_stage.py" target="_blank" rel="noopener">源代码</a>，只列举函数，不包括函数具体实现：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .base <span class="keyword">import</span> BaseDetector</span><br><span class="line"><span class="keyword">from</span> .test_mixins <span class="keyword">import</span> RPNTestMixin, BBoxTestMixin, MaskTestMixin</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> builder</span><br><span class="line"><span class="keyword">from</span> ..registry <span class="keyword">import</span> DETECTORS</span><br><span class="line"><span class="keyword">from</span> mmdet.core <span class="keyword">import</span> bbox2roi, bbox2result, build_assigner, build_sampler</span><br><span class="line"></span><br><span class="line"><span class="meta">@DETECTORS.register_module</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TwoStageDetector</span><span class="params">(BaseDetector, RPNTestMixin, BBoxTestMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">                       MaskTestMixin)</span>:</span></span><br><span class="line">    <span class="comment">##继承BaseDetector,RPNTestMixin,BBoxTestMixin,MaskTestMixin</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">                 backbone,</span></span></span><br><span class="line"><span class="function"><span class="params">                 neck=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 rpn_head=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 bbox_roi_extractor=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 bbox_head=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 mask_roi_extractor=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 mask_head=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 train_cfg=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 test_cfg=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 pretrained=None)</span>:</span></span><br><span class="line">        super(TwoStageDetector, self).__init__()</span><br><span class="line">        self.backbone = builder.build_backbone(backbone)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> neck <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            self.neck = builder.build_neck(neck)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">        <span class="comment">#默认neck不为空，后续应该会支持neck为空的情况，非FPN结构的模型</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> rpn_head <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            self.rpn_head = builder.build_head(rpn_head)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> bbox_head <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            self.bbox_roi_extractor = builder.build_roi_extractor(</span><br><span class="line">                bbox_roi_extractor)</span><br><span class="line">            self.bbox_head = builder.build_head(bbox_head)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mask_head <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            self.mask_roi_extractor = builder.build_roi_extractor(</span><br><span class="line">                mask_roi_extractor)</span><br><span class="line">            self.mask_head = builder.build_head(mask_head)</span><br><span class="line"></span><br><span class="line">        self.train_cfg = train_cfg</span><br><span class="line">        self.test_cfg = test_cfg</span><br><span class="line"></span><br><span class="line">        self.init_weights(pretrained=pretrained)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">with_rpn</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> hasattr(self, <span class="string">'rpn_head'</span>) <span class="keyword">and</span> self.rpn_head <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_weights</span><span class="params">(self, pretrained=None)</span>:</span></span><br><span class="line">        super(TwoStageDetector, self).init_weights(pretrained)</span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        not show in here</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">extract_feat</span><span class="params">(self, img)</span>:</span></span><br><span class="line">        x = self.backbone(img)</span><br><span class="line">        <span class="keyword">if</span> self.with_neck:</span><br><span class="line">            x = self.neck(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward_train</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">                      img,</span></span></span><br><span class="line"><span class="function"><span class="params">                      img_meta,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_bboxes,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_labels,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_bboxes_ignore=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_masks=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                      proposals=None)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        not show in here</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">simple_test</span><span class="params">(self, img, img_meta, proposals=None, rescale=False)</span>:</span></span><br><span class="line">        <span class="string">"""Test without augmentation."""</span></span><br><span class="line">        定义模型度测试（无数据增强）,返回的bbox_results(包含det_bboxes和 det_labels信息)以及segm_results</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">assert</span> self.with_bbox, <span class="string">"Bbox head must be implemented."</span></span><br><span class="line"></span><br><span class="line">        x = self.extract_feat(img)</span><br><span class="line"></span><br><span class="line">        proposal_list = self.simple_test_rpn(</span><br><span class="line">            x, img_meta, self.test_cfg.rpn) <span class="keyword">if</span> proposals <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">else</span> proposals</span><br><span class="line"></span><br><span class="line">        det_bboxes, det_labels = self.simple_test_bboxes(</span><br><span class="line">            x, img_meta, proposal_list, self.test_cfg.rcnn, rescale=rescale)</span><br><span class="line">        bbox_results = bbox2result(det_bboxes, det_labels,</span><br><span class="line">                                   self.bbox_head.num_classes)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.with_mask:</span><br><span class="line">            <span class="keyword">return</span> bbox_results</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            segm_results = self.simple_test_mask(</span><br><span class="line">                x, img_meta, det_bboxes, det_labels, rescale=rescale)</span><br><span class="line">            <span class="keyword">return</span> bbox_results, segm_results</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aug_test</span><span class="params">(self, imgs, img_metas, rescale=False)</span>:</span></span><br><span class="line">        <span class="string">"""Test with augmentations.</span></span><br><span class="line"><span class="string">        If rescale is False, then returned bboxes and masks will fit the scale</span></span><br><span class="line"><span class="string">        of imgs[0].</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        not show in here</span></span><br><span class="line"><span class="string">        '''</span></span><br></pre></td></tr></table></figure></p>
<h3 id="自定义数据集解析"><a href="#自定义数据集解析" class="headerlink" title="自定义数据集解析"></a>自定义数据集解析</h3><p>在mmdetecion中自定义了一种数据集格式。如<a href="https://github.com/open-mmlab/mmdetection/blob/master/README.md" target="_blank" rel="noopener">mmdetection/README.md</a>中suos所述。<br>We define a simple annotation format.The annotation of a dataset is a list of dict, each dict corresponds to an image.<br>There are 3 field <code>filename</code> (relative path), <code>width</code>, <code>height</code> for testing,<br>and an additional field <code>ann</code> for training. <code>ann</code> is also a dict containing at least 2 fields:<br><code>bboxes</code> and <code>labels</code>, both of which are numpy arrays. Some datasets may provide<br>annotations like crowd/difficult/ignored bboxes, we use <code>bboxes_ignore</code> and <code>labels_ignore</code><br>to cover them.</p>
<p>Here is an example.<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="symbol">'filename</span><span class="symbol">':</span> <span class="symbol">'a.jpg</span>',</span><br><span class="line">        <span class="symbol">'width</span><span class="symbol">':</span> <span class="number">1280</span>,</span><br><span class="line">        <span class="symbol">'height</span><span class="symbol">':</span> <span class="number">720</span>,</span><br><span class="line">        <span class="symbol">'ann</span><span class="symbol">':</span> &#123;</span><br><span class="line">            <span class="symbol">'bboxes</span><span class="symbol">':</span> &lt;np.ndarray&gt; (<span class="name">n</span>, <span class="number">4</span>),</span><br><span class="line">            <span class="symbol">'labels</span><span class="symbol">':</span> &lt;np.ndarray&gt; (<span class="name">n</span>, ),</span><br><span class="line">            <span class="symbol">'bboxes_ignore</span><span class="symbol">':</span> &lt;np.ndarray&gt; (<span class="name">k</span>, <span class="number">4</span>),</span><br><span class="line">            <span class="symbol">'labels_ignore</span><span class="symbol">':</span> &lt;np.ndarray&gt; (<span class="name">k</span>, ) (<span class="name">optional</span> field)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>There are two ways to work with custom datasets.</p>
<blockquote>
<ul>
<li><p><strong>online conversion</strong>：You can write a new Dataset class inherited from CustomDataset, and overwrite two methods <strong>load_annotations(self, ann_file)</strong> and <strong>get_ann_info(self, idx)</strong>, like <a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/coco.py" target="_blank" rel="noopener">CocoDataset</a> and <a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/voc.py" target="_blank" rel="noopener">VOCDataset</a>.</p>
</li>
<li><p><strong>offline conversion</strong>：You can convert the annotation format to the expected format above and save it to a pickle or json file, like <a href="https://github.com/open-mmlab/mmdetection/blob/master/tools/convert_datasets/pascal_voc.py" target="_blank" rel="noopener">pascal_voc.py</a>. Then you can simply use CustomDataset.</p>
</li>
</ul>
</blockquote>
<p>作者在CustomDataset基类上分别实例化了两种数据集类<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/coco.py" target="_blank" rel="noopener">CocoDataset</a>类以及<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/voc.py" target="_blank" rel="noopener">VOCDataset</a>类。其中VOCDataset数据集类虽然继承自<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/xml_style.py" target="_blank" rel="noopener">XMLDataset</a>类，但是XMLDataset也是继承自CustomDataset基类的。在mmdet.datasets.coco中实现了<a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/coco.py" target="_blank" rel="noopener">CocoDataset</a>类，其中包括对coco数据标注信息读取的一些类成员。源码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> pycocotools.coco <span class="keyword">import</span> COCO</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .custom <span class="keyword">import</span> CustomDataset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CocoDataset</span><span class="params">(CustomDataset)</span>:</span></span><br><span class="line"></span><br><span class="line">    CLASSES = (<span class="string">'person'</span>, <span class="string">'bicycle'</span>, <span class="string">'car'</span>, <span class="string">'motorcycle'</span>, <span class="string">'airplane'</span>, <span class="string">'bus'</span>,</span><br><span class="line">               <span class="string">'train'</span>, <span class="string">'truck'</span>, <span class="string">'boat'</span>, <span class="string">'traffic_light'</span>, <span class="string">'fire_hydrant'</span>,</span><br><span class="line">               <span class="string">'stop_sign'</span>, <span class="string">'parking_meter'</span>, <span class="string">'bench'</span>, <span class="string">'bird'</span>, <span class="string">'cat'</span>, <span class="string">'dog'</span>,</span><br><span class="line">               <span class="string">'horse'</span>, <span class="string">'sheep'</span>, <span class="string">'cow'</span>, <span class="string">'elephant'</span>, <span class="string">'bear'</span>, <span class="string">'zebra'</span>, <span class="string">'giraffe'</span>,</span><br><span class="line">               <span class="string">'backpack'</span>, <span class="string">'umbrella'</span>, <span class="string">'handbag'</span>, <span class="string">'tie'</span>, <span class="string">'suitcase'</span>, <span class="string">'frisbee'</span>,</span><br><span class="line">               <span class="string">'skis'</span>, <span class="string">'snowboard'</span>, <span class="string">'sports_ball'</span>, <span class="string">'kite'</span>, <span class="string">'baseball_bat'</span>,</span><br><span class="line">               <span class="string">'baseball_glove'</span>, <span class="string">'skateboard'</span>, <span class="string">'surfboard'</span>, <span class="string">'tennis_racket'</span>,</span><br><span class="line">               <span class="string">'bottle'</span>, <span class="string">'wine_glass'</span>, <span class="string">'cup'</span>, <span class="string">'fork'</span>, <span class="string">'knife'</span>, <span class="string">'spoon'</span>, <span class="string">'bowl'</span>,</span><br><span class="line">               <span class="string">'banana'</span>, <span class="string">'apple'</span>, <span class="string">'sandwich'</span>, <span class="string">'orange'</span>, <span class="string">'broccoli'</span>, <span class="string">'carrot'</span>,</span><br><span class="line">               <span class="string">'hot_dog'</span>, <span class="string">'pizza'</span>, <span class="string">'donut'</span>, <span class="string">'cake'</span>, <span class="string">'chair'</span>, <span class="string">'couch'</span>,</span><br><span class="line">               <span class="string">'potted_plant'</span>, <span class="string">'bed'</span>, <span class="string">'dining_table'</span>, <span class="string">'toilet'</span>, <span class="string">'tv'</span>, <span class="string">'laptop'</span>,</span><br><span class="line">               <span class="string">'mouse'</span>, <span class="string">'remote'</span>, <span class="string">'keyboard'</span>, <span class="string">'cell_phone'</span>, <span class="string">'microwave'</span>,</span><br><span class="line">               <span class="string">'oven'</span>, <span class="string">'toaster'</span>, <span class="string">'sink'</span>, <span class="string">'refrigerator'</span>, <span class="string">'book'</span>, <span class="string">'clock'</span>,</span><br><span class="line">               <span class="string">'vase'</span>, <span class="string">'scissors'</span>, <span class="string">'teddy_bear'</span>, <span class="string">'hair_drier'</span>, <span class="string">'toothbrush'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_annotations</span><span class="params">(self, ann_file)</span>:</span></span><br><span class="line">        <span class="string">"""return img_infos.</span></span><br><span class="line"><span class="string">        img_infos是一个列表，列表中每个元素均为一个字典，字典格式如下：</span></span><br><span class="line"><span class="string">        &#123;'filename': xxx.jpg,</span></span><br><span class="line"><span class="string">          'width': 1280,</span></span><br><span class="line"><span class="string">          'height': 720,</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        包含的都是图片的一些信息，当然在coco中，字典的内容还包括id,license，url等键值信息，但这些在训练过程中均为非必要信息，也就是说如果想训练自己的数据集，只需要重写load_annotations这个函数，并且返回如上格式数据信息就行</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.coco = COCO(ann_file)</span><br><span class="line">        self.cat_ids = self.coco.getCatIds()</span><br><span class="line">        self.cat2label = &#123;</span><br><span class="line">            cat_id: i + <span class="number">1</span></span><br><span class="line">            <span class="keyword">for</span> i, cat_id <span class="keyword">in</span> enumerate(self.cat_ids)</span><br><span class="line">        &#125;</span><br><span class="line">        self.img_ids = self.coco.getImgIds()</span><br><span class="line">        img_infos = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.img_ids:</span><br><span class="line">            info = self.coco.loadImgs([i])[<span class="number">0</span>]</span><br><span class="line">            info[<span class="string">'filename'</span>] = info[<span class="string">'file_name'</span>]</span><br><span class="line">            img_infos.append(info)</span><br><span class="line">        <span class="keyword">return</span> img_infos  </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_ann_info</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">    <span class="string">"""return annos.返回指定编号图片的标注信息</span></span><br><span class="line"><span class="string">    通过调用_parse_ann_info函数获取标注信息，最后返回数据格式也是字典，字典必须包含如下内容：</span></span><br><span class="line"><span class="string">    &#123;'bboxes': &lt;np.ndarray&gt; (n, 4),</span></span><br><span class="line"><span class="string">     'labels': &lt;np.ndarray&gt; (n, ),</span></span><br><span class="line"><span class="string">     'mask':  &lt;np.ndarray&gt; (width,height),</span></span><br><span class="line"><span class="string">     'bboxes_ignore': &lt;np.ndarray&gt; (k, 4),</span></span><br><span class="line"><span class="string">     'labels_ignore': &lt;np.ndarray&gt; (k, ) (非必要，在custom.py文件中，未见到该信息被使用)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">        img_id = self.img_infos[idx][<span class="string">'id'</span>]</span><br><span class="line">        ann_ids = self.coco.getAnnIds(imgIds=[img_id])</span><br><span class="line">        ann_info = self.coco.loadAnns(ann_ids)</span><br><span class="line">        <span class="keyword">return</span> self._parse_ann_info(ann_info, self.with_mask)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_filter_imgs</span><span class="params">(self, min_size=<span class="number">32</span>)</span>:</span></span><br><span class="line">        <span class="string">"""Filter images too small or without ground truths.</span></span><br><span class="line"><span class="string">        对数据集中图片过小，或没有标注信息的图片进行过滤</span></span><br><span class="line"><span class="string">        在这里设置的图片最小边长小于min_size=32的都过滤掉</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        valid_inds = []</span><br><span class="line">        ids_with_ann = set(_[<span class="string">'image_id'</span>] <span class="keyword">for</span> _ <span class="keyword">in</span> self.coco.anns.values())</span><br><span class="line">        <span class="keyword">for</span> i, img_info <span class="keyword">in</span> enumerate(self.img_infos):</span><br><span class="line">            <span class="keyword">if</span> self.img_ids[i] <span class="keyword">not</span> <span class="keyword">in</span> ids_with_ann:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> min(img_info[<span class="string">'width'</span>], img_info[<span class="string">'height'</span>]) &gt;= min_size:</span><br><span class="line">                valid_inds.append(i)</span><br><span class="line">        <span class="keyword">return</span> valid_inds</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_parse_ann_info</span><span class="params">(self, ann_info, with_mask=True)</span>:</span></span><br><span class="line">        <span class="string">"""Parse bbox and mask annotation.</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            ann_info (list[dict]): Annotation info of an image.</span></span><br><span class="line"><span class="string">            with_mask (bool): Whether to parse mask annotations.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            dict: A dict containing the following keys: bboxes, bboxes_ignore,</span></span><br><span class="line"><span class="string">                labels, masks, mask_polys, poly_lens.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        gt_bboxes = []</span><br><span class="line">        gt_labels = []</span><br><span class="line">        gt_bboxes_ignore = []</span><br><span class="line">        <span class="comment"># Two formats are provided.</span></span><br><span class="line">        <span class="comment"># 1. mask: a binary map of the same size of the image.</span></span><br><span class="line">        <span class="comment"># 2. polys: each mask consists of one or several polys, each poly is a</span></span><br><span class="line">        <span class="comment"># list of float.</span></span><br><span class="line">        <span class="keyword">if</span> with_mask:</span><br><span class="line">            gt_masks = []</span><br><span class="line">            gt_mask_polys = []</span><br><span class="line">            gt_poly_lens = []</span><br><span class="line">        <span class="keyword">for</span> i, ann <span class="keyword">in</span> enumerate(ann_info):</span><br><span class="line">            <span class="keyword">if</span> ann.get(<span class="string">'ignore'</span>, <span class="keyword">False</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            x1, y1, w, h = ann[<span class="string">'bbox'</span>]</span><br><span class="line">            <span class="keyword">if</span> ann[<span class="string">'area'</span>] &lt;= <span class="number">0</span> <span class="keyword">or</span> w &lt; <span class="number">1</span> <span class="keyword">or</span> h &lt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            bbox = [x1, y1, x1 + w - <span class="number">1</span>, y1 + h - <span class="number">1</span>]  <span class="comment">#x1,y1,x2,y2，左上角右下角格式</span></span><br><span class="line">            <span class="keyword">if</span> ann[<span class="string">'iscrowd'</span>]:</span><br><span class="line">                gt_bboxes_ignore.append(bbox)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                gt_bboxes.append(bbox)</span><br><span class="line">                gt_labels.append(self.cat2label[ann[<span class="string">'category_id'</span>]])</span><br><span class="line">            <span class="keyword">if</span> with_mask:</span><br><span class="line">                gt_masks.append(self.coco.annToMask(ann))</span><br><span class="line">                mask_polys = [</span><br><span class="line">                    p <span class="keyword">for</span> p <span class="keyword">in</span> ann[<span class="string">'segmentation'</span>] <span class="keyword">if</span> len(p) &gt;= <span class="number">6</span></span><br><span class="line">                ]  <span class="comment"># valid polygons have &gt;= 3 points (6 coordinates)</span></span><br><span class="line">                poly_lens = [len(p) <span class="keyword">for</span> p <span class="keyword">in</span> mask_polys]</span><br><span class="line">                gt_mask_polys.append(mask_polys)</span><br><span class="line">                gt_poly_lens.extend(poly_lens)</span><br><span class="line">        <span class="keyword">if</span> gt_bboxes:</span><br><span class="line">            gt_bboxes = np.array(gt_bboxes, dtype=np.float32)</span><br><span class="line">            gt_labels = np.array(gt_labels, dtype=np.int64)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gt_bboxes = np.zeros((<span class="number">0</span>, <span class="number">4</span>), dtype=np.float32)</span><br><span class="line">            gt_labels = np.array([], dtype=np.int64)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> gt_bboxes_ignore:</span><br><span class="line">            gt_bboxes_ignore = np.array(gt_bboxes_ignore, dtype=np.float32)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gt_bboxes_ignore = np.zeros((<span class="number">0</span>, <span class="number">4</span>), dtype=np.float32)</span><br><span class="line"></span><br><span class="line">        ann = dict(</span><br><span class="line">            bboxes=gt_bboxes, labels=gt_labels, bboxes_ignore=gt_bboxes_ignore)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> with_mask:</span><br><span class="line">            ann[<span class="string">'masks'</span>] = gt_masks</span><br><span class="line">            <span class="comment"># poly format is not used in the current implementation</span></span><br><span class="line">            ann[<span class="string">'mask_polys'</span>] = gt_mask_polys</span><br><span class="line">            ann[<span class="string">'poly_lens'</span>] = gt_poly_lens</span><br><span class="line">        <span class="keyword">return</span> ann</span><br></pre></td></tr></table></figure></p>
<p>从上面可以看出，CocoDataset类对CustomDataset类中的load_annotations函数以及get_ann_info函数进行了重写。通过重写的方式将coco数据格式转化为mmdetection的自定义数据集格式。在转化coco数据集的时候_parse_ann_info函数写的比较复杂，但是真正在训练测试用到的信息只有如下这些信息：<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;'bboxes': &lt;np.ndarray&gt; (<span class="name">n</span>, <span class="number">4</span>),</span><br><span class="line"> 'labels': &lt;np.ndarray&gt; (<span class="name">n</span>, ),</span><br><span class="line"> 'mask':  &lt;np.ndarray&gt; (<span class="name">width</span>,height),</span><br><span class="line"> 'bboxes_ignore': &lt;np.ndarray&gt; (<span class="name">k</span>, <span class="number">4</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至于voc格式数据集转换，可以自行阅读源码，和coco相比，要简单很多。建议在训练自己的数据时按照mmdetection在上面规定的数据格式进行转换就可以。</p>
<h3 id="demo有关代码解析"><a href="#demo有关代码解析" class="headerlink" title="demo有关代码解析"></a>demo有关代码解析</h3><p>在mmdetection的README.md文件中有关于测试图片并可视化的代码，比较简单，下面以maskrcnn作为模型进行测试的demox.py，源码如下所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">from</span> mmcv.runner <span class="keyword">import</span> load_checkpoint</span><br><span class="line"><span class="keyword">from</span> mmdet.models <span class="keyword">import</span> build_detector</span><br><span class="line"><span class="keyword">from</span> mmdet.apis <span class="keyword">import</span> inference_detector, show_result</span><br><span class="line"></span><br><span class="line">cfg = mmcv.Config.fromfile(<span class="string">'configs/mask_rcnn_r50_fpn_1x.py'</span>)</span><br><span class="line">cfg.model.pretrained = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># construct the model and load checkpoint</span></span><br><span class="line">model = build_detector(cfg.model, test_cfg=cfg.test_cfg)</span><br><span class="line">_ = load_checkpoint(model, <span class="string">'mask_rcnn_r50_fpn_2x_20181010-41d35c05.pth'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># test a single image</span></span><br><span class="line"><span class="comment">#img = mmcv.imread('img4.jpg')</span></span><br><span class="line"><span class="comment">#result = inference_detector(model, img, cfg)</span></span><br><span class="line"><span class="comment">#print(type(result[0]))</span></span><br><span class="line"><span class="comment">#show_result(img, result[0])</span></span><br><span class="line"><span class="comment"># test a list of images</span></span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line">imgs = glob.glob(<span class="string">'./*.jpg'</span>)</span><br><span class="line"><span class="keyword">for</span> i, result <span class="keyword">in</span> enumerate(inference_detector(model, imgs, cfg, device=<span class="string">'cuda:0'</span>)):</span><br><span class="line">    print(i, imgs[i])</span><br><span class="line">    show_result(imgs[i], result)</span><br></pre></td></tr></table></figure></p>
<p>如果在pytorch-0.4.1版本中运行该demo中出现如下问题时，<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent <span class="keyword">call</span> <span class="keyword">last</span>):</span><br><span class="line">  <span class="keyword">File</span> <span class="string">"demox.py"</span>, line <span class="number">23</span>, <span class="keyword">in</span> &lt;<span class="keyword">module</span>&gt;</span><br><span class="line">    show_result(imgs[i], <span class="keyword">result</span>)</span><br><span class="line">  <span class="keyword">File</span> <span class="string">"/home/niceliu/mmdetection/mmdet/apis/inference.py"</span>, line <span class="number">55</span>, <span class="keyword">in</span> show_result</span><br><span class="line">    <span class="keyword">for</span> i, bbox <span class="keyword">in</span> enumerate(<span class="keyword">result</span>)</span><br><span class="line">  <span class="keyword">File</span> <span class="string">"/home/niceliu/mmdetection/mmdet/apis/inference.py"</span>, line <span class="number">55</span>, <span class="keyword">in</span> &lt;listcomp&gt;</span><br><span class="line">    <span class="keyword">for</span> i, bbox <span class="keyword">in</span> enumerate(<span class="keyword">result</span>)</span><br><span class="line">AttributeError: <span class="string">'list'</span> <span class="keyword">object</span> has <span class="keyword">no</span> <span class="keyword">attribute</span> <span class="string">'shape'</span></span><br></pre></td></tr></table></figure></p>
<p>需要对在mmdet/apis/inference.py文件中，对函数show_result进行修改，完整的show_result函数源码如下：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">def show_result(img, result, dataset='coco', score_thr=<span class="number">0.3</span>, out_file=None):</span><br><span class="line">    img = mmcv.imread(img)</span><br><span class="line">    class_names = get_classes(dataset)</span><br><span class="line">    <span class="keyword">if</span> isinstance(result, tuple):</span><br><span class="line">        bbox_result, segm_result = result</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        bbox_result, segm_result = result, None</span><br><span class="line">    bboxes = <span class="built_in">np</span>.vstack(bbox_result)</span><br><span class="line">    # <span class="built_in">draw</span> segmentation masks</span><br><span class="line">    <span class="keyword">if</span> segm_result <span class="built_in">is</span> <span class="keyword">not</span> None:</span><br><span class="line">        segms = mmcv.concat_list(segm_result)</span><br><span class="line">        inds = <span class="built_in">np</span>.where(bboxes[:, -<span class="number">1</span>] &gt; score_thr)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> inds:</span><br><span class="line">            color_mask = <span class="built_in">np</span>.<span class="built_in">random</span>.randint(</span><br><span class="line">                <span class="number">0</span>, <span class="number">256</span>, (<span class="number">1</span>, <span class="number">3</span>), dtype=<span class="built_in">np</span>.uint8)</span><br><span class="line">            mask = maskUtils.decode(segms[i]).astype(<span class="built_in">np</span>.bool)</span><br><span class="line">            img[mask] = img[mask] * <span class="number">0.5</span> + color_mask * <span class="number">0.5</span></span><br><span class="line">    # <span class="built_in">draw</span> bounding boxes</span><br><span class="line">    <span class="built_in">labels</span> = [</span><br><span class="line">        <span class="built_in">np</span>.full(bbox.shape[<span class="number">0</span>], i, dtype=<span class="built_in">np</span>.int32)</span><br><span class="line">        <span class="keyword">for</span> i, bbox <span class="keyword">in</span> enumerate(bbox_result)</span><br><span class="line">    ]</span><br><span class="line">    <span class="built_in">labels</span> = <span class="built_in">np</span>.concatenate(<span class="built_in">labels</span>)</span><br><span class="line">    mmcv.imshow_det_bboxes(</span><br><span class="line">        img.<span class="built_in">copy</span>(),</span><br><span class="line">        bboxes,</span><br><span class="line">        <span class="built_in">labels</span>,</span><br><span class="line">        class_names=class_names,</span><br><span class="line">        score_thr=score_thr,</span><br><span class="line">        <span class="built_in">show</span>=out_file <span class="built_in">is</span> None)</span><br></pre></td></tr></table></figure></p>
<p>在demox.py文件中着重关注inference_detector接口函数，该函数位于mmdet.api.inference.py文件中。有关代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_inference_single</span><span class="params">(model, img, img_transform, cfg, device)</span>:</span></span><br><span class="line">    img = mmcv.imread(img)</span><br><span class="line">    data = _prepare_data(img, img_transform, cfg, device)</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        result = model(return_loss=<span class="keyword">False</span>, rescale=<span class="keyword">True</span>, **data)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_inference_generator</span><span class="params">(model, imgs, img_transform, cfg, device)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> imgs:</span><br><span class="line">        <span class="keyword">yield</span> _inference_single(model, img, img_transform, cfg, device)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inference_detector</span><span class="params">(model, imgs, cfg, device=<span class="string">'cuda:0'</span>)</span>:</span></span><br><span class="line">    img_transform = ImageTransform(</span><br><span class="line">        size_divisor=cfg.data.test.size_divisor, **cfg.img_norm_cfg)</span><br><span class="line">    model = model.to(device)</span><br><span class="line">    model.eval()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(imgs, list):</span><br><span class="line">        <span class="keyword">return</span> _inference_single(model, imgs, img_transform, cfg, device)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> _inference_generator(model, imgs, img_transform, cfg, device)</span><br></pre></td></tr></table></figure></p>
<p>源码比较简单，不予介绍，最后放几张demo的测试结果图。<br><img src="/img/mmdetection_demo2.png" alt><br><img src="/img/mmdetection_demo1.png" alt></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mmdetection/" rel="tag"># mmdetection</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/02/docker/" rel="next" title="解决环境依赖问题的神器：Docker">
                <i class="fa fa-chevron-left"></i> 解决环境依赖问题的神器：Docker
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/15/FCOS/" rel="prev" title="论文阅读：Fully Convolutional One-Stage Object Detection(FCOS)">
                论文阅读：Fully Convolutional One-Stage Object Detection(FCOS) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/avatar/weichat.jpg" alt="nicehuster">
          <p class="site-author-name" itemprop="name">nicehuster</p>
           
              <p class="site-description motion-element" itemprop="description">欢迎来到小白(@nicehuster)的博客。</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">89</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">42</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/nicehuster" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      Github
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://blog.csdn.net/auto1993" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      CSDN
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/u/3335530510" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#训练"><span class="nav-number">2.</span> <span class="nav-text">训练</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tools-train-py使用"><span class="nav-number">2.1.</span> <span class="nav-text">tools/train.py使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tools-train-py源码解析"><span class="nav-number">2.2.</span> <span class="nav-text">tools/train.py源码解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试"><span class="nav-number">3.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tools-test-py使用"><span class="nav-number">3.1.</span> <span class="nav-text">tools/test.py使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可视化预测"><span class="nav-number">3.2.</span> <span class="nav-text">可视化预测</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#models模型实现"><span class="nav-number">4.</span> <span class="nav-text">models模型实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#single-stage-py源码解析"><span class="nav-number">4.1.</span> <span class="nav-text">single_stage.py源码解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#two-stage-py源码解析"><span class="nav-number">4.2.</span> <span class="nav-text">two_stage.py源码解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义数据集解析"><span class="nav-number">5.</span> <span class="nav-text">自定义数据集解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo有关代码解析"><span class="nav-number">6.</span> <span class="nav-text">demo有关代码解析</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nicehuster</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
