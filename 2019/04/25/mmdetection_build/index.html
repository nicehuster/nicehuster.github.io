<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="E3FpB-yqMjVKzHwdisKMpUn104x78HxTRcD4_v_URgc">







  <meta name="baidu-site-verification" content="wgGFRLcCc9">







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="mmdetection,">





  <link rel="alternate" href="/atom.xml" title="一起打怪升级呀" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="&amp;#160; &amp;#160; &amp;#160; &amp;#160;在mmdetection中，实现了许多现有two-stage目标检测方法以及one-stage目标检测方法，且包含完整的数据载入、模型构建、模型训练以及模型测试部分的源码。因此非常适合在此基础上扩展实现其他目标检测算法。关于数据载入、模型训练以及模型测试部分的源码，在上一篇博客中有详细介绍。后期打算在mmdetection基础上添加其他算法。因">
<meta name="keywords" content="mmdetection">
<meta property="og:type" content="article">
<meta property="og:title" content="mmdetection(pytorch0.4.1版本)模型构建部分源码解析">
<meta property="og:url" content="https://blog.nicehuster.cn/2019/04/25/mmdetection_build/index.html">
<meta property="og:site_name" content="一起打怪升级呀">
<meta property="og:description" content="&amp;#160; &amp;#160; &amp;#160; &amp;#160;在mmdetection中，实现了许多现有two-stage目标检测方法以及one-stage目标检测方法，且包含完整的数据载入、模型构建、模型训练以及模型测试部分的源码。因此非常适合在此基础上扩展实现其他目标检测算法。关于数据载入、模型训练以及模型测试部分的源码，在上一篇博客中有详细介绍。后期打算在mmdetection基础上添加其他算法。因">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://blog.nicehuster.cn/img/fpn.png">
<meta property="og:image" content="https://blog.nicehuster.cn/img/head_arch.png">
<meta property="og:updated_time" content="2020-09-18T02:38:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mmdetection(pytorch0.4.1版本)模型构建部分源码解析">
<meta name="twitter:description" content="&amp;#160; &amp;#160; &amp;#160; &amp;#160;在mmdetection中，实现了许多现有two-stage目标检测方法以及one-stage目标检测方法，且包含完整的数据载入、模型构建、模型训练以及模型测试部分的源码。因此非常适合在此基础上扩展实现其他目标检测算法。关于数据载入、模型训练以及模型测试部分的源码，在上一篇博客中有详细介绍。后期打算在mmdetection基础上添加其他算法。因">
<meta name="twitter:image" content="https://blog.nicehuster.cn/img/fpn.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.nicehuster.cn/2019/04/25/mmdetection_build/">





  <title>mmdetection(pytorch0.4.1版本)模型构建部分源码解析 | 一起打怪升级呀</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一起打怪升级呀</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">别整太大鸭力,多鸡立自己qaq</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.nicehuster.cn/2019/04/25/mmdetection_build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nicehuster">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/avatar/weichat.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一起打怪升级呀">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">mmdetection(pytorch0.4.1版本)模型构建部分源码解析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-25T19:13:39+08:00">
                2019-04-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/project/" itemprop="url" rel="index">
                    <span itemprop="name">project</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&#160; &#160; &#160; &#160;在mmdetection中，实现了许多现有two-stage目标检测方法以及one-stage目标检测方法，且包含完整的数据载入、模型构建、模型训练以及模型测试部分的源码。因此非常适合在此基础上扩展实现其他目标检测算法。关于数据载入、模型训练以及模型测试部分的源码，在上一篇博客中有详细介绍。后期打算在mmdetection基础上添加其他算法。因此了解模型构建这部分源码十分重要。在mmdetecion官方<a href="https://github.com/open-mmlab/mmdetection" target="_blank" rel="noopener">github</a>介绍模型主要由四部分组成：backbone, neck, head, 以及ROI extractor。<br><a id="more"></a><br>&#160; &#160; &#160; &#160;阅读mmdetection源码最简单地主线就是根据模型配置文件configs/*.py文件中model部分去阅读。在mmdetection中，two-stage类目标检测方法model部分内容通常包含：backbone，neck，rpn_head，bbox_roi_extractor和bbox_head共五个部分。当然，在maskrcnn中还包括mask_roi_extractor和mask_head。以maskrcnn模型的配置文件中model部分为例，介绍模型构建部分，下面是maskrcnn模型中model部分配置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">model = dict(</span><br><span class="line">    <span class="attribute">type</span>=<span class="string">'MaskRCNN'</span>,  #模型名，对应模型声明在mmdet/modelsp/detectors/mask_rcnn.py文件中</span><br><span class="line">    <span class="attribute">pretrained</span>=<span class="string">'modelzoo://resnet50'</span>, #backbone的预训练模型</span><br><span class="line">    <span class="attribute">backbone</span>=dict(</span><br><span class="line">        <span class="attribute">type</span>=<span class="string">'ResNet'</span>,</span><br><span class="line">        <span class="attribute">depth</span>=50, </span><br><span class="line">        <span class="attribute">num_stages</span>=4,</span><br><span class="line">        out_indices=(0, 1, 2, 3),</span><br><span class="line">        <span class="attribute">frozen_stages</span>=1, </span><br><span class="line">        <span class="attribute">style</span>=<span class="string">'pytorch'</span>, </span><br><span class="line">        <span class="attribute">dcn</span>=dict(        </span><br><span class="line">            <span class="attribute">modulated</span>=<span class="literal">False</span>,</span><br><span class="line">            <span class="attribute">deformable_groups</span>=1,</span><br><span class="line">            <span class="attribute">fallback_on_stride</span>=<span class="literal">False</span>),</span><br><span class="line">        stage_with_dcn=(<span class="literal">False</span>, <span class="literal">True</span>, <span class="literal">True</span>, <span class="literal">True</span>)),</span><br><span class="line">    <span class="attribute">neck</span>=dict(                   </span><br><span class="line">        <span class="attribute">type</span>=<span class="string">'FPN'</span>,</span><br><span class="line">        in_channels=[256, 512, 1024, 2048],</span><br><span class="line">        <span class="attribute">out_channels</span>=256,</span><br><span class="line">        <span class="attribute">num_outs</span>=5),</span><br><span class="line">    <span class="attribute">rpn_head</span>=dict(</span><br><span class="line">        <span class="attribute">type</span>=<span class="string">'RPNHead'</span>,</span><br><span class="line">        <span class="attribute">in_channels</span>=256,</span><br><span class="line">        <span class="attribute">feat_channels</span>=256,</span><br><span class="line">        anchor_scales=[8],</span><br><span class="line">        anchor_ratios=[0.5, 1.0, 2.0],</span><br><span class="line">        anchor_strides=[4, 8, 16, 32, 64],</span><br><span class="line">        target_means=[.0, .0, .0, .0],</span><br><span class="line">        target_stds=[1.0, 1.0, 1.0, 1.0],</span><br><span class="line">        <span class="attribute">use_sigmoid_cls</span>=<span class="literal">True</span>),</span><br><span class="line">    <span class="attribute">bbox_roi_extractor</span>=dict(</span><br><span class="line">        <span class="attribute">type</span>=<span class="string">'SingleRoIExtractor'</span>,</span><br><span class="line">        <span class="attribute">roi_layer</span>=dict(type='RoIAlign', <span class="attribute">out_size</span>=7, <span class="attribute">sample_num</span>=2),</span><br><span class="line">        <span class="attribute">out_channels</span>=256,</span><br><span class="line">        featmap_strides=[4, 8, 16, 32]),</span><br><span class="line">    <span class="attribute">bbox_head</span>=dict(</span><br><span class="line">        <span class="attribute">type</span>=<span class="string">'SharedFCBBoxHead'</span>,</span><br><span class="line">        <span class="attribute">num_fcs</span>=2,</span><br><span class="line">        <span class="attribute">in_channels</span>=256,</span><br><span class="line">        <span class="attribute">fc_out_channels</span>=1024,</span><br><span class="line">        <span class="attribute">roi_feat_size</span>=7,</span><br><span class="line">        <span class="attribute">num_classes</span>=81,</span><br><span class="line">        target_means=[0., 0., 0., 0.],</span><br><span class="line">        target_stds=[0.1, 0.1, 0.2, 0.2],</span><br><span class="line">        <span class="attribute">reg_class_agnostic</span>=<span class="literal">False</span>),</span><br><span class="line">    <span class="attribute">mask_roi_extractor</span>=dict(</span><br><span class="line">        <span class="attribute">type</span>=<span class="string">'SingleRoIExtractor'</span>,</span><br><span class="line">        <span class="attribute">roi_layer</span>=dict(type='RoIAlign', <span class="attribute">out_size</span>=14, <span class="attribute">sample_num</span>=2),</span><br><span class="line">        <span class="attribute">out_channels</span>=256,</span><br><span class="line">        featmap_strides=[4, 8, 16, 32]),</span><br><span class="line">    <span class="attribute">mask_head</span>=dict(</span><br><span class="line">        <span class="attribute">type</span>=<span class="string">'FCNMaskHead'</span>,</span><br><span class="line">        <span class="attribute">num_convs</span>=4,</span><br><span class="line">        <span class="attribute">in_channels</span>=256,</span><br><span class="line">        <span class="attribute">conv_out_channels</span>=256,</span><br><span class="line">        <span class="attribute">num_classes</span>=81))</span><br></pre></td></tr></table></figure></p>
<p><strong>注意</strong>：</p>
<blockquote>
<ul>
<li>上面的pretrained参数只是针对backbone部分的预训练权重，在mmdetection中除了支持pytorch的modelzoo之外，mmdetection也提供了部分预训练权重，具体可以查看mmcv/runner/checkpoint.py文件。</li>
<li>如果想对整个模型进行预训练，比如我使用coco数据集预训练模型去训练pascal voc，则可以在configs/*.py文件中load_from参数，来指定coco预训练模型权重文件路径。</li>
</ul>
</blockquote>
<h3 id="Backbone-amp-amp-neck"><a href="#Backbone-amp-amp-neck" class="headerlink" title="Backbone &amp;&amp; neck"></a><strong>Backbone &amp;&amp; neck</strong></h3><p>&#160; &#160; &#160; &#160;目前官方实现了backbone包括：resnet,resnext以及ssd_vgg。作者在resnet基础上还实现了dcn。至于neck部分目前只有FPN，而且对于two-stage方法，neck只能设置为FPN，对应代码实现部分在mmdet/models/necks/fpn.py。backbone和neck相关的配置参数如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">backbone</span>=dict(</span><br><span class="line">    <span class="attribute">type</span>=<span class="string">'ResNet'</span>,</span><br><span class="line">    <span class="attribute">depth</span>=50, </span><br><span class="line">    <span class="attribute">num_stages</span>=4,</span><br><span class="line">    out_indices=(0, 1, 2, 3),</span><br><span class="line">    <span class="attribute">frozen_stages</span>=1,  #由于stage1的feature map比较大，因此冻结住，训练阶段可以节省内存</span><br><span class="line">    <span class="attribute">style</span>=<span class="string">'pytorch'</span>,  #预训练模型载入来源，可以是caffe</span><br><span class="line">    <span class="attribute">dcn</span>=dict(         #dcn参数配置，如果仅仅使用普通resnet50，可以设置<span class="attribute">dcn</span>=None</span><br><span class="line">        <span class="attribute">modulated</span>=<span class="literal">False</span>,</span><br><span class="line">        <span class="attribute">deformable_groups</span>=1,</span><br><span class="line">        <span class="attribute">fallback_on_stride</span>=<span class="literal">False</span>),</span><br><span class="line">    stage_with_dcn=(<span class="literal">False</span>, <span class="literal">True</span>, <span class="literal">True</span>, <span class="literal">True</span>))，</span><br><span class="line"><span class="attribute">neck</span>=dict(                   </span><br><span class="line">    <span class="attribute">type</span>=<span class="string">'FPN'</span>,</span><br><span class="line">    in_channels=[256, 512, 1024, 2048], #对应于resnet的4个stage（C2,C3,C4,C5）输出通道数</span><br><span class="line">    <span class="attribute">out_channels</span>=256,                   #对应(P2,P3,P4,P5,P6)的输出通道数</span><br><span class="line">    <span class="attribute">num_outs</span>=5),                        #5个输出，对应P2-P6</span><br></pre></td></tr></table></figure></p>
<p>&#160; &#160; &#160; &#160;backbone部分代码实现部分在mmdet/models/backbones/*.py文件中。neck部分代码实现部分在mmdet/models/necks/fpn.py文件中。这两部分代码的实现不难，不予介绍，FPN结构如下图所示。值得注意的是，RetinaNet模型中neck部分也是采用的FPN，对应neck部分配置却不一样，RetinaNet模型中neck部分参数如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">neck</span>=dict(</span><br><span class="line">    <span class="attribute">type</span>=<span class="string">'FPN'</span>,</span><br><span class="line">    in_channels=[256, 512, 1024, 2048],</span><br><span class="line">    <span class="attribute">out_channels</span>=256,</span><br><span class="line">    <span class="attribute">start_level</span>=1,</span><br><span class="line">    <span class="attribute">add_extra_convs</span>=<span class="literal">True</span>,</span><br><span class="line">    <span class="attribute">num_outs</span>=5)</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/fpn.png" alt><br>&#160; &#160; &#160; &#160;额外添加了start_level和add_extra_convs两个参数。start_level=1表示从C3开始，因为RetinaNet模型中FPN的输出并不是P2-P6这5个输出，在RetinaNet中FPN的输出采用的是P3-P7这5个输出。在maskrcnn的FPN结构中是直接通过对P5进行maxpool得到P6，而在RetinaNet中，P6通过对P5进行stride=2卷积操作得到的，而P7则是同样对P6进行stride=2卷积操作得到。这一部分的区别，可以看源码mmdet/models/necks/fpn.py文件中第72行。</p>
<h3 id="rpn-head"><a href="#rpn-head" class="headerlink" title="rpn_head"></a><strong>rpn_head</strong></h3><p>&#160; &#160; &#160; &#160;这一部分主要涉及到anchor的相关操作，在mmdet/models/anchor_heads文件夹下实现了多种anchor_heads，其中包括基类AnchorHead(实现在anchor_head.py文件中），RetinaNet模型相关的RetinaHead类(实现在retina_head.py文件中），two-stage方法的RPNHead类（实现在rpn_head.py文件中）以及SSD方法SSDHead（实现在ssd_head.py文件中）。后面三个类都继承自AnchorHead基类。在maskrcnn中使用的anchor_head是RPNHead类，对应配置参数如下：<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rpn_head=dict(</span></span><br><span class="line">    <span class="attr">type='RPNHead',</span> <span class="comment"># anchor_head类型为RPNHead</span></span><br><span class="line">    <span class="attr">in_channels=256,</span> <span class="comment"># FPN中每个level的输出通道数，通常都为256</span></span><br><span class="line">    <span class="attr">feat_channels=256,</span> <span class="comment"># RPN的feature map的通道数</span></span><br><span class="line">    <span class="attr">anchor_scales=[8],</span> <span class="comment"># anchor的尺度，在使用FPN结构时，每个level只有一种尺度</span></span><br><span class="line">    <span class="attr">anchor_ratios=[0.5,</span> <span class="number">1.0</span>, <span class="number">2.0</span>], <span class="comment">#anchor比例：1:2,1:1,2:1这三种</span></span><br><span class="line">    <span class="attr">anchor_strides=[4,</span> <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>], <span class="comment">#对应于FPN中每个level的featuremap上每个pixel的感受野大小；</span></span><br><span class="line">    <span class="attr">target_means=[.0,</span> .<span class="number">0</span>, .<span class="number">0</span>, .<span class="number">0</span>],</span><br><span class="line">    <span class="attr">target_stds=[1.0,</span> <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>],</span><br><span class="line">    <span class="attr">use_sigmoid_cls=True)</span> <span class="comment">#anchor前景背景分类采用sigmoid，在早期的fasterrcnn采用的是softmax,在mmdetection中没有实现softmax分类</span></span><br></pre></td></tr></table></figure></p>
<p>对应RPNHead类的实现如下：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RPNHead</span>(<span class="title">AnchorHead</span>): <span class="comment">#继承自AnchorHead类</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, in_channels, **kwargs)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">super</span>(RPNHead, <span class="keyword">self</span>).__init_<span class="number">_</span>(<span class="number">2</span>, in_channels, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_init_layers</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.rpn_conv = nn.Conv2d(</span><br><span class="line">            <span class="keyword">self</span>.in_channels, <span class="keyword">self</span>.feat_channels, <span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">self</span>.rpn_cls = nn.Conv2d(<span class="keyword">self</span>.feat_channels,</span><br><span class="line">                                 <span class="keyword">self</span>.num_anchors * <span class="keyword">self</span>.cls_out_channels, <span class="number">1</span>)</span><br><span class="line">                                 </span><br><span class="line">        <span class="keyword">self</span>.rpn_reg = nn.Conv2d(<span class="keyword">self</span>.feat_channels, <span class="keyword">self</span>.num_anchors * <span class="number">4</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_weights</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        normal_init(<span class="keyword">self</span>.rpn_conv, std=<span class="number">0</span>.<span class="number">01</span>)</span><br><span class="line">        normal_init(<span class="keyword">self</span>.rpn_cls, std=<span class="number">0</span>.<span class="number">01</span>)</span><br><span class="line">        normal_init(<span class="keyword">self</span>.rpn_reg, std=<span class="number">0</span>.<span class="number">01</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward_single</span><span class="params">(<span class="keyword">self</span>, x)</span></span>:  <span class="comment">#表示输入FPN的一个level，比如P6输入，P6：1*256*13*16</span></span><br><span class="line">        x = <span class="keyword">self</span>.rpn_conv(x)      <span class="comment">#conv不改变featuremap大小，且feat_channels=256，故x:1*256*13*16</span></span><br><span class="line">        x = F.relu(x, inplace=True)</span><br><span class="line">        rpn_cls_score = <span class="keyword">self</span>.rpn_cls(x)  <span class="comment">#对应于anchor的前景背景分类 1*3*13*16</span></span><br><span class="line">        rpn_bbox_pred = <span class="keyword">self</span>.rpn_reg(x)  <span class="comment">#对应于anchor的回归 1*12*13*16</span></span><br><span class="line">        <span class="keyword">return</span> rpn_cls_score, rpn_bbox_pred  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loss</span><span class="params">(<span class="keyword">self</span>, cls_scores, bbox_preds, gt_bboxes, img_metas, cfg)</span></span><span class="symbol">:</span></span><br><span class="line"></span><br><span class="line">        losses = <span class="keyword">super</span>(RPNHead, <span class="keyword">self</span>).loss(cls_scores, bbox_preds, gt_bboxes,</span><br><span class="line">                                           None, img_metas, cfg)</span><br><span class="line">        <span class="keyword">return</span> dict(</span><br><span class="line">            loss_rpn_cls=losses[<span class="string">'loss_cls'</span>], loss_rpn_reg=losses[<span class="string">'loss_reg'</span>])</span><br></pre></td></tr></table></figure></p>
<p>RPNHead类中实现的函数只是对AnchorHead类中部分函数的重写。由于RPNHead继承自AnchorHead类，在实际训练和测试中，直接调用的是还是继承自AnchorHead类的forward的函数。在RPN中通过在13x16的featuremap上生成13x16x3个anchors（注意，这里使用的是FPN结构，在不同level上，每个点只生成3个anchor，因此生成的anchors数是13x16x3）。经过后处理选择出proposal进行后续的bbox_roi_extractor。其中后处理操作包括：</p>
<blockquote>
<ul>
<li>删除背景框（13x16x3）；</li>
<li>NMS处理去除重合度大的框中分数低的那个；</li>
<li>取分数最大的K（top-k）个框用于后续bbox_roi_extractor；</li>
</ul>
</blockquote>
<p>这部分比较复杂，还涉及到一些RPN损失函数，比如smoth_l1_loss，focal loss以及delta2box的转换等等操作，直接看源码比较容易理解。关于Anchors这部分，<a href="https://www.cnblogs.com/q735613050/p/10631619.html" target="_blank" rel="noopener">推荐博客</a>讲解的比较清楚，推荐看。</p>
<h3 id="ROI-extractor"><a href="#ROI-extractor" class="headerlink" title="ROI extractor"></a><strong>ROI extractor</strong></h3><p>&#160; &#160; &#160; &#160;在maskrcnn模型中，这部分涉及到box的操作以及mask的操作：bbox_roi_extractor和mask_roi_extractor。相关的配置如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bbox_roi_extractor</span>=dict(</span><br><span class="line">    <span class="attribute">type</span>=<span class="string">'SingleRoIExtractor'</span>,</span><br><span class="line">    <span class="attribute">roi_layer</span>=dict(type='RoIAlign', <span class="attribute">out_size</span>=7, <span class="attribute">sample_num</span>=2), #roi输出大小为7<span class="number">*7</span></span><br><span class="line">    <span class="attribute">out_channels</span>=256, #roi输出通道数</span><br><span class="line">    featmap_strides=[4, 8, 16, 32]),  #对应4个level的proposal</span><br><span class="line"><span class="attribute">mask_roi_extractor</span>=dict(</span><br><span class="line">    <span class="attribute">type</span>=<span class="string">'SingleRoIExtractor'</span>,</span><br><span class="line">    <span class="attribute">roi_layer</span>=dict(type='RoIAlign', <span class="attribute">out_size</span>=14, <span class="attribute">sample_num</span>=2),</span><br><span class="line">    <span class="attribute">out_channels</span>=256,</span><br><span class="line">    featmap_strides=[4, 8, 16, 32]),</span><br></pre></td></tr></table></figure></p>
<p>在上面的配置参数可以看出，bbox_roi_extractor和mask_roi_extractor的roi_layer层类型都是SingleRoIExtractor。这个层的实现在mmdet/models/roi_extractors/single_level.py文件中。在FPN+RPN分别输出4个不同level的proposal，因此或生成4个对应的roi_layer，每个roi_layer输出的特征通道数out_channels=256。对于box，每个roi的大小为7x7；对于mask，每个roi的输出大小14x14。</p>
<p>经过ROI extractor操作之后就是bbox的回归和分类以及mask的生成分类。这部分的配置参数如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bbox_head</span>=dict(</span><br><span class="line">    <span class="attribute">type</span>=<span class="string">'SharedFCBBoxHead'</span>,</span><br><span class="line">    <span class="attribute">num_fcs</span>=2, #2个全连接层</span><br><span class="line">    <span class="attribute">in_channels</span>=256, #roi输出特征通道数</span><br><span class="line">    <span class="attribute">fc_out_channels</span>=1024, #2个全连接层的节点数</span><br><span class="line">    <span class="attribute">roi_feat_size</span>=7,</span><br><span class="line">    <span class="attribute">num_classes</span>=81, #81个类别输出（80目标+1背景）</span><br><span class="line">    target_means=[0., 0., 0., 0.],</span><br><span class="line">    target_stds=[0.1, 0.1, 0.2, 0.2],</span><br><span class="line">    <span class="attribute">reg_class_agnostic</span>=<span class="literal">False</span>),</span><br><span class="line"><span class="attribute">mask_head</span>=dict(</span><br><span class="line">    <span class="attribute">type</span>=<span class="string">'FCNMaskHead'</span>,</span><br><span class="line">    <span class="attribute">num_convs</span>=4, #4个卷积层</span><br><span class="line">    <span class="attribute">in_channels</span>=256, #roi输出特征通道数</span><br><span class="line">    <span class="attribute">conv_out_channels</span>=256, #4个卷积层的通道数均为256</span><br><span class="line">    <span class="attribute">num_classes</span>=81))    #mask的类别是81，</span><br></pre></td></tr></table></figure></p>
<p>这一部分的实现对应于下图，该图截图自maskrcnn原文，如下图所示<br><img src="/img/head_arch.png" alt><br>值得注意的是，在上面mask branch中倒数第二层应该是28x28x256的上采样层,在上面的参数配置中没有体现，但在mmdetection的代码有实现，可以看mmdet/models/mask_heads/fcn_mask_head.py中FCNMaskHead默认的上采样层类型是deconv，层的实现在第58行。</p>
<h3 id="模型构建"><a href="#模型构建" class="headerlink" title="模型构建"></a><strong>模型构建</strong></h3><p>&#160; &#160; &#160; &#160;上面根据模型配置文件结构介绍了构建maskrcnn模型的4个子模块，如何将这四个子模块拼接构成一个完整的maskrcnn模型？在mmdetecion中实例化一个具体模型，需要在mmdet/models/detectors/文件夹下中实现相应的模型，比如maskrcnn模型的实现在该文件夹下mask_rcnn.py文件中，实现如下：<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">from <span class="string">.two_stage</span> import TwoStageDetector</span><br><span class="line">from <span class="string">..registry</span> import DETECTORS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@DETECTORS.register_module</span><br><span class="line">class MaskRCNN<span class="params">(TwoStageDetector)</span>:</span><br><span class="line"></span><br><span class="line">    def __init__<span class="params">(self,</span></span><br><span class="line"><span class="params">                 backbone,</span></span><br><span class="line"><span class="params">                 neck,</span></span><br><span class="line"><span class="params">                 rpn_head,</span></span><br><span class="line"><span class="params">                 bbox_roi_extractor,</span></span><br><span class="line"><span class="params">                 bbox_head,</span></span><br><span class="line"><span class="params">                 mask_roi_extractor,</span></span><br><span class="line"><span class="params">                 mask_head,</span></span><br><span class="line"><span class="params">                 train_cfg,</span></span><br><span class="line"><span class="params">                 test_cfg,</span></span><br><span class="line"><span class="params">                 <span class="attr">pretrained</span>=None)</span>:</span><br><span class="line">        super<span class="params">(MaskRCNN, self)</span><span class="string">.__init__</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="attr">backbone</span>=backbone,</span></span><br><span class="line"><span class="params">            <span class="attr">neck</span>=neck,</span></span><br><span class="line"><span class="params">            <span class="attr">rpn_head</span>=rpn_head,</span></span><br><span class="line"><span class="params">            <span class="attr">bbox_roi_extractor</span>=bbox_roi_extractor,</span></span><br><span class="line"><span class="params">            <span class="attr">bbox_head</span>=bbox_head,</span></span><br><span class="line"><span class="params">            <span class="attr">mask_roi_extractor</span>=mask_roi_extractor,</span></span><br><span class="line"><span class="params">            <span class="attr">mask_head</span>=mask_head,</span></span><br><span class="line"><span class="params">            <span class="attr">train_cfg</span>=train_cfg,</span></span><br><span class="line"><span class="params">            <span class="attr">test_cfg</span>=test_cfg,</span></span><br><span class="line"><span class="params">            <span class="attr">pretrained</span>=pretrained)</span></span><br></pre></td></tr></table></figure></p>
<p>从上面可以看出maskrcnn模型的构建继承自TwoStageDetector类。TwoStageDetector类是一个通用的two-stage目标检测方法的基类，具体实现如下：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line">import torch</span><br><span class="line">import torch.nn as nn</span><br><span class="line"></span><br><span class="line">from .base import BaseDetector</span><br><span class="line">from .test_mixins import RPNTestMixin, BBoxTestMixin, MaskTestMixin</span><br><span class="line">from .. import builder</span><br><span class="line">from ..registry import DETECTORS</span><br><span class="line">from mmdet.core import bbox2roi, bbox2result, build_assigner, build_sampler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@DETECTORS.register_module</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TwoStageDetector</span>(<span class="title">BaseDetector</span>, <span class="title">RPNTestMixin</span>, <span class="title">BBoxTestMixin</span>,</span></span><br><span class="line">                       MaskTestMixin)<span class="symbol">:</span></span><br><span class="line"><span class="comment">#继承了四个基类BaseDetector（主要是一些模型常见训练，单多尺度测试相关操作的虚函数），RPNTestMixin，BBoxTestMixin，MaskTestMixin主要是模型单尺度/多尺度测试</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 backbone,</span></span></span><br><span class="line"><span class="function"><span class="params">                 neck=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 rpn_head=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 bbox_roi_extractor=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 bbox_head=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 mask_roi_extractor=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 mask_head=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 train_cfg=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 test_cfg=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 pretrained=None)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">super</span>(TwoStageDetector, <span class="keyword">self</span>).__init_<span class="number">_</span>()</span><br><span class="line">        <span class="keyword">self</span>.backbone = builder.build_backbone(backbone)  <span class="comment">#根据配置文件构架backbone</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> neck is <span class="keyword">not</span> <span class="symbol">None:</span></span><br><span class="line">            <span class="keyword">self</span>.neck = builder.build_neck(neck)        <span class="comment">#根据配置文件构架neck,这里主要是FPN</span></span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            raise NotImplementedError           </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> rpn_head is <span class="keyword">not</span> <span class="symbol">None:</span></span><br><span class="line">            <span class="keyword">self</span>.rpn_head = builder.build_head(rpn_head) <span class="comment">#根据配置文件构架rpn</span></span><br><span class="line">        <span class="comment">#根据配置文件构架bbox_roi_extractor,bbox_head</span></span><br><span class="line">        <span class="keyword">if</span> bbox_head is <span class="keyword">not</span> <span class="symbol">None:</span></span><br><span class="line">            <span class="keyword">self</span>.bbox_roi_extractor = builder.build_roi_extractor(</span><br><span class="line">                bbox_roi_extractor)</span><br><span class="line">            <span class="keyword">self</span>.bbox_head = builder.build_head(bbox_head)</span><br><span class="line">        <span class="comment">#根据配置文件构架mask_roi_extractor,mask_head</span></span><br><span class="line">        <span class="keyword">if</span> mask_head is <span class="keyword">not</span> <span class="symbol">None:</span></span><br><span class="line">            <span class="keyword">self</span>.mask_roi_extractor = builder.build_roi_extractor(</span><br><span class="line">                mask_roi_extractor)</span><br><span class="line">            <span class="keyword">self</span>.mask_head = builder.build_head(mask_head)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.train_cfg = train_cfg</span><br><span class="line">        <span class="keyword">self</span>.test_cfg = test_cfg</span><br><span class="line">        <span class="comment">#模型参数权重初始化</span></span><br><span class="line">        <span class="keyword">self</span>.init_weights(pretrained=pretrained)</span><br><span class="line"></span><br><span class="line">    @property</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">with_rpn</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> hasattr(<span class="keyword">self</span>, <span class="string">'rpn_head'</span>) <span class="keyword">and</span> <span class="keyword">self</span>.rpn_head is <span class="keyword">not</span> None</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_weights</span><span class="params">(<span class="keyword">self</span>, pretrained=None)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">super</span>(TwoStageDetector, <span class="keyword">self</span>).init_weights(pretrained)</span><br><span class="line">        <span class="keyword">self</span>.backbone.init_weights(pretrained=pretrained)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_neck:</span></span><br><span class="line">            <span class="keyword">if</span> isinstance(<span class="keyword">self</span>.neck, nn.Sequential)<span class="symbol">:</span></span><br><span class="line">                <span class="keyword">for</span> m <span class="keyword">in</span> <span class="keyword">self</span>.<span class="symbol">neck:</span></span><br><span class="line">                    m.init_weights()</span><br><span class="line">            <span class="symbol">else:</span></span><br><span class="line">                <span class="keyword">self</span>.neck.init_weights()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_rpn:</span></span><br><span class="line">            <span class="keyword">self</span>.rpn_head.init_weights()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_bbox:</span></span><br><span class="line">            <span class="keyword">self</span>.bbox_roi_extractor.init_weights()</span><br><span class="line">            <span class="keyword">self</span>.bbox_head.init_weights()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_mask:</span></span><br><span class="line">            <span class="keyword">self</span>.mask_roi_extractor.init_weights()</span><br><span class="line">            <span class="keyword">self</span>.mask_head.init_weights()</span><br><span class="line">    <span class="comment">#提取特征（包括经过bakcbone,neck）</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">extract_feat</span><span class="params">(<span class="keyword">self</span>, img)</span></span><span class="symbol">:</span></span><br><span class="line">        x = <span class="keyword">self</span>.backbone(img)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_neck:</span></span><br><span class="line">            x = <span class="keyword">self</span>.neck(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward_train</span><span class="params">(<span class="keyword">self</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      img,</span></span></span><br><span class="line"><span class="function"><span class="params">                      img_meta,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_bboxes,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_bboxes_ignore,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_labels,</span></span></span><br><span class="line"><span class="function"><span class="params">                      gt_masks=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                      proposals=None)</span></span><span class="symbol">:</span></span><br><span class="line">        x = <span class="keyword">self</span>.extract_feat(img)</span><br><span class="line">      </span><br><span class="line">        losses = dict()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># RPN 前向计算和损失</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_rpn:</span></span><br><span class="line">            rpn_outs = <span class="keyword">self</span>.rpn_head(x)</span><br><span class="line">            rpn_loss_inputs = rpn_outs + (gt_bboxes, img_meta,</span><br><span class="line">                                          <span class="keyword">self</span>.train_cfg.rpn)</span><br><span class="line">            rpn_losses = <span class="keyword">self</span>.rpn_head.loss(*rpn_loss_inputs)</span><br><span class="line">            losses.update(rpn_losses)</span><br><span class="line"></span><br><span class="line">            proposal_inputs = rpn_outs + (img_meta, <span class="keyword">self</span>.test_cfg.rpn)</span><br><span class="line">            proposal_list = <span class="keyword">self</span>.rpn_head.get_bboxes(*proposal_inputs)</span><br><span class="line">        <span class="symbol">else:</span></span><br><span class="line">            proposal_list = proposals</span><br><span class="line"></span><br><span class="line">        <span class="comment"># assign gts and sample proposals</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.with_bbox <span class="keyword">or</span> <span class="keyword">self</span>.<span class="symbol">with_mask:</span></span><br><span class="line">            bbox_assigner = build_assigner(<span class="keyword">self</span>.train_cfg.rcnn.assigner)</span><br><span class="line">            bbox_sampler = build_sampler(</span><br><span class="line">                <span class="keyword">self</span>.train_cfg.rcnn.sampler, context=<span class="keyword">self</span>)</span><br><span class="line">            num_imgs = img.size(<span class="number">0</span>)</span><br><span class="line">            sampling_results = []</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(num_imgs)<span class="symbol">:</span></span><br><span class="line">                assign_result = bbox_assigner.assign(</span><br><span class="line">                    proposal_list[i], gt_bboxes[i], gt_bboxes_ignore[i],</span><br><span class="line">                    gt_labels[i])</span><br><span class="line">                sampling_result = bbox_sampler.sample(</span><br><span class="line">                    assign_result,</span><br><span class="line">                    proposal_list[i],</span><br><span class="line">                    gt_bboxes[i],</span><br><span class="line">                    gt_labels[i],</span><br><span class="line">                    feats=[lvl_feat[i][None] <span class="keyword">for</span> lvl_feat <span class="keyword">in</span> x])</span><br><span class="line">                sampling_results.append(sampling_result)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># bbox head forward and loss</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_bbox:</span></span><br><span class="line">            rois = bbox2roi([res.bboxes <span class="keyword">for</span> res <span class="keyword">in</span> sampling_results])</span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> a more flexible way to decide which feature maps to use</span></span><br><span class="line">            bbox_feats = <span class="keyword">self</span>.bbox_roi_extractor(</span><br><span class="line">                x[<span class="symbol">:self</span>.bbox_roi_extractor.num_inputs], rois)</span><br><span class="line">            cls_score, bbox_pred = <span class="keyword">self</span>.bbox_head(bbox_feats)</span><br><span class="line"></span><br><span class="line">            bbox_targets = <span class="keyword">self</span>.bbox_head.get_target(</span><br><span class="line">                sampling_results, gt_bboxes, gt_labels, <span class="keyword">self</span>.train_cfg.rcnn)</span><br><span class="line">            loss_bbox = <span class="keyword">self</span>.bbox_head.loss(cls_score, bbox_pred,</span><br><span class="line">                                            *bbox_targets)</span><br><span class="line">            losses.update(loss_bbox)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># mask head forward and loss</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">with_mask:</span></span><br><span class="line">            pos_rois = bbox2roi([res.pos_bboxes <span class="keyword">for</span> res <span class="keyword">in</span> sampling_results])</span><br><span class="line">            mask_feats = <span class="keyword">self</span>.mask_roi_extractor(</span><br><span class="line">                x[<span class="symbol">:self</span>.mask_roi_extractor.num_inputs], pos_rois)</span><br><span class="line">            mask_pred = <span class="keyword">self</span>.mask_head(mask_feats)</span><br><span class="line"></span><br><span class="line">            mask_targets = <span class="keyword">self</span>.mask_head.get_target(</span><br><span class="line">                sampling_results, gt_masks, <span class="keyword">self</span>.train_cfg.rcnn)</span><br><span class="line">            pos_labels = torch.cat(</span><br><span class="line">                [res.pos_gt_labels <span class="keyword">for</span> res <span class="keyword">in</span> sampling_results])</span><br><span class="line">            loss_mask = <span class="keyword">self</span>.mask_head.loss(mask_pred, mask_targets,</span><br><span class="line">                                            pos_labels)</span><br><span class="line">            losses.update(loss_mask)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> losses</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">simple_test</span><span class="params">(<span class="keyword">self</span>, img, img_meta, proposals=None, rescale=False)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="string">""</span><span class="string">"Test without augmentation."</span><span class="string">""</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">aug_test</span><span class="params">(<span class="keyword">self</span>, imgs, img_metas, rescale=False)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="string">""</span><span class="string">"Test with augmentations.</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mmdetection/" rel="tag"># mmdetection</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/23/CornerNet/" rel="next" title="论文阅读：Detecting Objects as Paired Keypoints(CornerNet)">
                <i class="fa fa-chevron-left"></i> 论文阅读：Detecting Objects as Paired Keypoints(CornerNet)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/28/supervisely-person-datasets/" rel="prev" title="使用mmdetection训练supervisely-person-datasets">
                使用mmdetection训练supervisely-person-datasets <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/avatar/weichat.jpg" alt="nicehuster">
          <p class="site-author-name" itemprop="name">nicehuster</p>
           
              <p class="site-description motion-element" itemprop="description">欢迎来到小白(@nicehuster)的博客。</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">117</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">58</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/nicehuster" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      Github
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://blog.csdn.net/auto1993" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      CSDN
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/u/3335530510" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Backbone-amp-amp-neck"><span class="nav-number">1.</span> <span class="nav-text">Backbone &amp;&amp; neck</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rpn-head"><span class="nav-number">2.</span> <span class="nav-text">rpn_head</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ROI-extractor"><span class="nav-number">3.</span> <span class="nav-text">ROI extractor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模型构建"><span class="nav-number">4.</span> <span class="nav-text">模型构建</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nicehuster</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
